---
phase: 01-enable-list-drag-and-drop
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/api/lists.js
  - frontend/src/hooks/useBoardDetail.js
autonomous: true

must_haves:
  truths:
    - "reorderLists() sends a request body with key `lists`, not `items`"
    - "useMoveList optimistically reorders the cached list columns"
    - "useMoveList rolls back the cached order when the API call fails"
    - "useMoveList invalidates the board query after settling so server state is synced"
  artifacts:
    - path: "frontend/src/api/lists.js"
      provides: "reorderLists API helper with correct body key"
      contains: "{ lists:"
    - path: "frontend/src/hooks/useBoardDetail.js"
      provides: "useMoveList mutation hook"
      exports: ["useMoveList"]
      contains: "export const useMoveList"
  key_links:
    - from: "frontend/src/hooks/useBoardDetail.js"
      to: "frontend/src/api/lists.js"
      via: "reorderLists import"
      pattern: "import.*reorderLists.*from.*api/lists"
    - from: "useMoveList onMutate"
      to: "queryClient.setQueryData"
      via: "optimistic list reorder"
      pattern: "setQueryData.*lists.*sort"
---

<objective>
Fix the FIX-01 body-key mismatch and add the useMoveList mutation hook.

Purpose: The backend PATCH /api/lists/reorder endpoint expects `{ lists: [...] }` but the
current reorderLists() helper sends `{ items: [...] }`. This fix unblocks all list reorder
calls. useMoveList is the hook BoardPage will call on list drop — it mirrors useMoveCard
exactly (optimistic update → rollback on error → invalidate on settled).

Output:
  - frontend/src/api/lists.js — reorderLists sends { lists: [...] }
  - frontend/src/hooks/useBoardDetail.js — exports useMoveList
</objective>

<execution_context>
../.github/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/PROJECT.md
@.gsd/ROADMAP.md
@.gsd/STATE.md
@frontend/src/api/lists.js
@frontend/src/hooks/useBoardDetail.js
</context>

<tasks>

<task type="auto">
  <name>Task 1 — FIX-01: correct reorderLists request body key</name>
  <files>frontend/src/api/lists.js</files>
  <action>
    In the reorderLists function, change the request body from `{ items }` to `{ lists }`.

    Current (wrong):
      const response = await api.patch('/lists/reorder', { items });

    Target (correct):
      export const reorderLists = async (lists) => {
        const response = await api.patch('/lists/reorder', { lists });
        return response.data;
      };

    Also update the JSDoc above the function:
      - Change parameter name from `items` to `lists`
      - Change the Body line from `Body: { items: [{ id, position }] }` to `Body: { lists: [{ id, position }] }`
  </action>
  <verify>
    Grep confirms body key:
      grep "{ lists" frontend/src/api/lists.js
    Should output a line containing `{ lists }` or `{ lists:`.
    Grep confirms `items` is gone:
      grep "items" frontend/src/api/lists.js
    Should return no matches.
  </verify>
  <done>
    reorderLists(lists) sends PATCH /lists/reorder with body `{ lists: [...] }`.
    No reference to `items` remains in the file.
  </done>
</task>

<task type="auto">
  <name>Task 2 — Add useMoveList mutation hook to useBoardDetail.js</name>
  <files>frontend/src/hooks/useBoardDetail.js</files>
  <action>
    1. Add `reorderLists` to the existing import from `'../api/lists'` at the top of the file.

    2. Append the following export AFTER the existing useMoveCard export (keep the file structure):

    ```js
    // ─── useMoveList ─────────────────────────────────────────────────────────────

    /**
     * Mutation: reorder list columns on the board.
     *
     * Accepts: { boardId, lists } where lists is the COMPLETE ordered array
     * of list objects with rebalanced positions already applied:
     *   lists = sortedLists.map((l, i) => ({ ...l, position: (i + 1) * 1000 }))
     *
     * Uses optimistic update:
     * 1. Snapshot current board data.
     * 2. Immediately update cached board.lists order + positions.
     * 3. On error, roll back to the snapshot.
     * 4. On settled, invalidate to sync with server.
     */
    export const useMoveList = (boardId) => {
      const queryClient = useQueryClient();
      const queryKey = boardKeys.detail(boardId);

      return useMutation({
        mutationFn: ({ lists }) =>
          reorderLists(lists.map((l) => ({ id: l.id, position: l.position }))),

        onMutate: async ({ lists }) => {
          await queryClient.cancelQueries({ queryKey });

          const previousBoard = queryClient.getQueryData(queryKey);

          queryClient.setQueryData(queryKey, (old) => {
            if (!old) return old;
            return { ...old, lists };
          });

          return { previousBoard };
        },

        onError: (_err, _vars, context) => {
          if (context?.previousBoard) {
            queryClient.setQueryData(queryKey, context.previousBoard);
          }
        },

        onSettled: () => {
          queryClient.invalidateQueries({ queryKey });
        },
      });
    };
    ```

    The `lists` passed into mutationFn are the full list objects with rebalanced positions.
    Only `{ id, position }` pairs are sent to the API. The cached board is updated with the
    full rebalanced list objects so UI position values and server values stay in sync after
    the subsequent invalidation refetch.
  </action>
  <verify>
    Grep confirms export:
      grep "export const useMoveList" frontend/src/hooks/useBoardDetail.js
    Should find the export.

    Grep confirms reorderLists import is present:
      grep "reorderLists" frontend/src/hooks/useBoardDetail.js
    Should show at least two lines (import + usage inside mutationFn).
  </verify>
  <done>
    useMoveList(boardId) is exported from useBoardDetail.js.
    It calls reorderLists with the correct payload shape.
    onMutate applies optimistic reorder to the board cache.
    onError rolls back to the snapshot.
    onSettled invalidates the board query.
  </done>
</task>

</tasks>

<verification>
Run both grep checks from each task's verify section.
No TypeScript/lint errors (run: cd frontend && npm run lint 2>&1 | head -30 — if lint script exists).
</verification>

<success_criteria>
- reorderLists sends `{ lists: [...] }` to PATCH /api/lists/reorder
- useMoveList is exported from useBoardDetail.js with optimistic update + rollback pattern
- No references to the old `items` key remain in lists.js
</success_criteria>

<output>
After completion, create `.gsd/phases/01-enable-list-drag-and-drop/01-01-SUMMARY.md`
</output>
